tinymce.PluginManager.add("octo_link",function(t){function e(){var t="",e='<div class="mce-not-inline mce-menu-item mce-menu-item-normal mce-first mce-stack-layout-item mce-link-row">',n="</div>";return t+=e+'<span class="mce-input-name-txt">link</span> <input type="text" name="href" value="">'+n,t+=e+'<span class="mce-input-name-txt">title</span> <input type="text" name="title" value="">'+n,t+=e+'<input type="checkbox" name="target_blank" value="1"> <span class="mce-input-name-txt">open link in a new window</span>'+n}function n(t){return t.control.panel?t.control.panel:t.control}function l(e){function l(e,n){var l=t.selection.getRng();window.setTimeout(function(){t.windowManager.confirm(e,function(e){t.selection.setRng(l),n(e)})},0)}function i(){var n={href:o,target:c.target?c.target:null,rel:c.rel?c.rel:null,"class":c["class"]?c["class"]:null,title:c.title?c.title:null};if(r._lastAnchorElm)t.focus(),s.setAttribs(r._lastAnchorElm,n),r._lastSelection.select(r._lastAnchorElm),t.undoManager.add();else if(r._lastOnlyText){var l=s.createHTML("a",n,s.encode(r._lastSelContent));t.insertContent(l),t._lastCreatedNode||console.error("Can not find last inserted node for "+l),r._lastSelection.select(t._lastCreatedNode),a(e)}else t.execCommand("mceInsertLink",!1,n);r._lastLinkSet=(new Date).getMilliseconds()}var o,r=n(e),c={},s=t.dom,d=jQuery("#"+r._id),u=d.find('[name="href"]'),f=d.find('[name="title"]'),m=d.find('[name="target_blank"]');return c.href=u.val(),c.title=f.val(),c.target=m.attr("checked")?"_blank":null,(o=c.href)?o.indexOf("@")>0&&-1==o.indexOf("//")&&-1==o.indexOf("mailto:")?void l("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(t){t&&(o="mailto:"+o),i()}):void i():void t.execCommand("unlink")}function a(e){var l=n(e),a=t.dom,o=t.selection.getNode();l._lastAnchorElm=a.getParent(o,"a[href]"),l._lastOnlyText=i(l._lastAnchorElm),l._lastSelContent=t.selection.getContent(),l._lastSelNode=t.selection.getNode(),l._lastSelection=t.selection}function i(e){var n=t.selection.getContent();if(/</.test(n)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(n)||-1==n.indexOf("href=")))return!1;if(e){var l,a=e.childNodes;if(0===a.length)return!1;for(l=a.length-1;l>=0;l--)if(3!=a[l].nodeType)return!1}return!0}function o(e){if(e.control.panel){var i,o={},r=t.dom,c=jQuery("#"+e.control.panel._id),s=c.is(":visible"),d=c.find('[name="href"]'),u=c.find('[name="title"]'),f=c.find('[name="target_blank"]');if(s){d.focus();var m=n(e);m._octInited||(d.change(function(){l(e)}).click(function(){var t=(new Date).getMilliseconds();m._lastLinkSet&&t-m._lastLinkSet<=100&&jQuery(this).focus()}),u.change(function(){l(e)}).click(function(){var t=(new Date).getMilliseconds();m._lastLinkSet&&t-m._lastLinkSet<=100&&jQuery(this).focus()}),f.change(function(){l(e)}),octInitCustomCheckRadio(c),m._octInited=!0),a(e),o.href=m._lastAnchorElm?r.getAttrib(m._lastAnchorElm,"href"):"",m._lastAnchorElm?o.target=r.getAttrib(m._lastAnchorElm,"target"):t.settings.default_link_target&&(o.target=t.settings.default_link_target),(i=r.getAttrib(m._lastAnchorElm,"rel"))&&(o.rel=i),(i=r.getAttrib(m._lastAnchorElm,"class"))&&(o["class"]=i),(i=r.getAttrib(m._lastAnchorElm,"title"))&&(o.title=i),d.val(o.href),u.val(o.title?o.title:""),"_blank"==o.target?f.attr("checked","checked"):f.removeAttr("checked"),octCheckUpdate(f)}}}t.addButton("octo_link",{type:"panelbutton",icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:o,stateSelector:"a[href]",panel:{role:"application",html:e,border:1,onhide:function(t){l(t)}}})});